<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            overflow: hidden; /* Ensure no scrollbars appear */
            text-align: center;
        }
        h3 {
            margin: 0 0 15px 0;
            color: #555;
        }
        .button-container {
            margin-top: 20px;
        }
        button {
            margin: 0 5px;
            padding: 8px 15px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #45a049;
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        #cancelButton {
            background-color: #f44336; 
        }
        #cancelButton:hover {
            background-color: #d32f2f;
        }
        #loading {
            display: none;
            margin-top: 20px;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 10px auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } 
        }
        #notificationContainer {
            display: none;
            width: 300px; /* Adjust width as needed */
            padding: 20px;
            border-radius: 5px;
            background-color: #fff;  /* Set background color to white */
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 1000;
        }
        #notification {
            margin-bottom: 15px;
        }
        #notificationButtons {
            display: flex;
            flex-direction: row;
            justify-content: center;
            align-items: center;
            gap: 10px; /* Space between buttons */
        }
        #notificationButtons button {
            padding: 10px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
        }
        #notificationButtons button:hover {
            background-color: #45a049;
        }
        #info {
            display: none;
            background-color: #e7f3fe;
            border: 1px solid #b6d4fe;
            color: #004085;
            padding: 10px;
            margin-top: 15px;
            border-radius: 4px;
            font-size: 14px;
        }
        #error {
            display: none;
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 10px;
            margin-top: 15px;
            border-radius: 4px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div id="content">
        <h3>Are you sure you want to download the XLSX file?</h3>
        <div class="button-container">
            <button id="cancelButton">Cancel</button>
            <button id="confirmButton">Confirm</button>
        </div>
    </div>

    <div id="loading">
        <div class="spinner"></div>
    </div>

    <div id="notificationContainer">
        <p id="notification"></p>
        <div id="notificationButtons"></div>
    </div>

    <div id="info"></div>
    <div id="error"></div>

    <script>
        let isDownloadInProgress = false;

        document.addEventListener('DOMContentLoaded', function () {
            document.getElementById('confirmButton').addEventListener('click', confirmDownload);
            document.getElementById('cancelButton').addEventListener('click', function () {
                google.script.host.close();
            });
            console.log('DOM fully loaded and parsed.')
        });

        function confirmDownload() {
            console.log("confirmDownload called");
            if (isDownloadInProgress) {
                displayInfo("An XLSX file is already being downloaded. Please wait.");
                return;
            }
            isDownloadInProgress = true;
            console.log("Download process started");

            displayInfo("Starting the download process. Please wait...");
            showLoading();

            google.script.run
                .withSuccessHandler(function (result) {
                    clearInfo();
                    if (result.error) {
                        const errorMessage = result.message || "Unknown error.";  // Fallback if message is not present
                        switch (result.error) {
                            case "PARTIAL_SUCCESS":
                                console.error(`Partial success with message: ${errorMessage}`);
                                showFileCreatedNotification(result, errorMessage);
                                break;
                            default:
                                console.error(`Failed to create file: ${errorMessage}`);
                                displayError("Failed to create file: " + errorMessage);
                                sendErrorEmail(errorMessage);
                        }
                    } else if (result && result.base64Data) {
                        const blob = b64toBlob(result.base64Data, result.mimeType);
                        const url = URL.createObjectURL(blob);
                        const link = document.createElement('a');
                        link.href = url;
                        link.download = result.fileName;

                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        URL.revokeObjectURL(url);

                        showFileCreatedNotification(result);
                    } else {
                        const errorMessage = "Invalid result from downloadAsXLSM";
                        console.error(errorMessage, result);
                        displayError("Failed to create file. Please try again.");
                        sendErrorEmail(errorMessage);
                    }
                    resetDownloadButton();
                })
                .withFailureHandler(function (error) {
                    const errorMessage = error.message || "Unknown error";
                    clearInfo();
                    console.error(`Error downloading file: ${errorMessage}`);
                    displayError("Error downloading file: " + errorMessage);
                    sendErrorEmail(errorMessage);
                    resetDownloadButton();
                })
                .downloadAsXLSX();
        }

        function showLoading() {
            document.getElementById('content').style.display = 'none';
            document.getElementById('loading').style.display = 'block';
        }

        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }

        function showFileCreatedNotification(result, errorMessage = null) {
            console.log("showFileCreatedNotification called");
            let message = `<strong>${result.fileName} was created and downloaded, but there may be a slight issue with formatting.</strong><br><br> Use the links below or check your local Downloads folder to access your file.`;

            if (result.error === "PARTIAL_SUCCESS") {
                message = `<strong>Warning:</strong> The file was created but there was an issue.<br><br>Use the links below or check your local Downloads folder to access your file.<br><br> Error details: ${errorMessage}.<br><br>An email has been sent to the project's administrator.`;
                console.error(`Partial success with message: ${errorMessage}`);
                sendErrorEmail(errorMessage);
            }

            updateNotification(message, true);

            const buttonContainer = document.getElementById('notificationButtons');
            if (buttonContainer) {
                buttonContainer.innerHTML = '';
                buttonContainer.className = 'button-container';

                addOpenFileButton(result.driveFileUrl);
                addOpenDriveFolderButton(result.parentFolderUrl);
            } else {
                console.error("Button container not found");
            }
        }

        function addOpenFileButton(fileUrl) {
            var openFileButton = document.createElement('button');
            openFileButton.textContent = 'Open File';
            openFileButton.onclick = function () {
                window.open(fileUrl, '_blank');
                closeDownloadFileUI();
            };
            document.getElementById('notificationButtons').appendChild(openFileButton);
        }

        function addOpenDriveFolderButton(folderUrl) {
            var openDriveFolderButton = document.createElement('button');
            openDriveFolderButton.textContent = 'Open Drive Folder';
            openDriveFolderButton.onclick = function () {
                window.open(folderUrl, '_blank');
                closeDownloadFileUI();
            };
            document.getElementById('notificationButtons').appendChild(openDriveFolderButton);
        }

        function displayInfo(message) {
            var infoElement = document.getElementById('info');
            infoElement.textContent = message;
            infoElement.style.display = 'block';
        }

        function clearInfo() {
            var infoElement = document.getElementById('info');
            if (infoElement) {
                infoElement.style.display = 'none';
            }
        }

        function displayError(message) {
            var errorElement = document.getElementById('error');
            errorElement.innerHTML = message;
            errorElement.style.display = 'block';
            sendErrorEmail(message);
        }

        function updateNotification(message, showButtons) {
            const notificationContainer = document.getElementById('notificationContainer');
            const notification = document.getElementById('notification');
            const buttonContainer = document.getElementById('notificationButtons');

            notification.innerHTML = message;

            if (showButtons) {
                buttonContainer.style.display = 'flex';
            } else {
                buttonContainer.style.display = 'none';
            }

            notificationContainer.style.display = 'block';
            hideLoading();
        }

        function closeDownloadFileUI() {
            const notificationContainer = document.getElementById('notificationContainer');
            notificationContainer.style.display = 'none';
            document.getElementById('content').style.display = 'block';
        }

        function resetDownloadButton() {
            isDownloadInProgress = false;
            document.getElementById('confirmButton').disabled = false;
        }

        function b64toBlob(b64Data, contentType = '', sliceSize = 512) {
            const byteCharacters = atob(b64Data);
            const byteArrays = [];

            for (let offset = 0; offset < byteCharacters.length; offset += sliceSize) {
                const slice = byteCharacters.slice(offset, offset + sliceSize);
                const byteNumbers = new Array(slice.length);
                for (let i = 0; i < slice.length; i++) {
                    byteNumbers[i] = slice.charCodeAt(i);
                }
                const byteArray = new Uint8Array(byteNumbers);
                byteArrays.push(byteArray);
            }

            return new Blob(byteArrays, { type: contentType });
        }

        function sendErrorEmail(errorMessage) {
            google.script.run.sendErrorEmail(errorMessage);
        }
    </script>
</body>
</html>