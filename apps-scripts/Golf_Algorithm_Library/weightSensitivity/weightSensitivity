/**
 * Weight Sensitivity Analysis Utilities
 * -------------------------------------
 * Functions to support systematic testing of model sensitivity to metric weights.
 * These are designed for use with Jest and Node.js, not directly in Apps Script.
 */

/**
 * Systematically vary a single metric's weight and measure effect on accuracy metrics.
 * For now, this uses mock accuracy calculations.
 * @param {string} metricName - The metric to test
 * @param {object} options - {min, max, step}
 * @returns {Array} Array of results for each weight tested
 */
function calculateMetricSensitivity(metricName, options) {
  const results = [];
  const { min, max, step } = options;
  for (let w = min; w <= max; w += step) {
    // TODO: Replace mock calculations with real model evaluation
    results.push({
      metric: metricName,
      weight: Number(w.toFixed(4)),
      rmse: Math.random() * 10 + 50, // mock RMSE
      correlation: Math.random() * 0.5, // mock correlation
      top10Accuracy: Math.random() * 100 // mock %
    });
  }
  return results;
}

/**
 * Aggregate results for all metrics.
 * @param {Array} metrics - Array of metric names
 * @param {object} options - {min, max, step}
 * @returns {Array} Array of all results
 */
function performWeightSensitivityAnalysis(metrics, options) {
  let allResults = [];
  for (const metric of metrics) {
    const metricResults = calculateMetricSensitivity(metric, options);
    allResults = allResults.concat(metricResults);
  }
  return allResults;
}

/**
 * Analyze which weights are most/least impactful (mock implementation).
 * @param {Array} allResults
 * @returns {object} Summary of sensitivity scores
 */
function analyzeWeightEffectiveness(allResults) {
  // Example: Find metric with largest RMSE range
  const grouped = {};
  allResults.forEach(r => {
    if (!grouped[r.metric]) grouped[r.metric] = [];
    grouped[r.metric].push(r.rmse);
  });
  const summary = {};
  for (const metric in grouped) {
    const values = grouped[metric];
    summary[metric] = {
      rmseRange: Math.max(...values) - Math.min(...values)
    };
  }
  return summary;
}

module.exports = {
  calculateMetricSensitivity,
  performWeightSensitivityAnalysis,
  analyzeWeightEffectiveness
};